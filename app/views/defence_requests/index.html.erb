<div class="row">
  <h1>CSO DASHBOARD</h1>
</div>
<div class="row new_defence_request">
  <%= link_to t('new_defence_request'), new_defence_request_path, class: 'btn btn-default' %>
</div>
<div class="row">
  <table class="table table-striped table-bordered defence_requests">
    <thead>
    <tr>
      <th>#</th>
      <th><%= t('solicitor_type') %></th>
      <th><%= t('solicitor_name') %></th>
      <th><%= t('solicitor_firm') %></th>
      <th><%= t('scheme') %></th>
      <th><%= t('phone_number') %></th>
      <th><%= t('detainee_surname') %></th>
      <th><%= t('detainee_first_name') %></th>
      <th><%= t('gender') %></th>
      <th><%= t('adult') %></th>
      <th><%= t('date_of_birth') %></th>
      <th><%= t('appropriate_adult') %></th>
      <th><%= t('custody_number') %></th>
      <th><%= t('allegations') %></th>
      <th><%= t('comments') %></th>
      <th><%= t('time_of_arrival') %></th>
    </tr>
    </thead>
    <tbody>
    <% @defence_requests.each_with_index do |def_req, ind| %>
      <tr id=<%= "dr_#{def_req.id}" %>>
        <th scope="row"><%= ind %></th>
        <td><%= def_req.solicitor_type %></td>
        <td><%= def_req.solicitor_name %></td>
        <td><%= def_req.solicitor_firm %></td>
        <td><%= def_req.scheme %></td>
        <td><%= def_req.phone_number %></td>
        <td><%= def_req.detainee_surname %></td>
        <td><%= def_req.detainee_first_name %></td>
        <td><%= def_req.gender %></td>
        <td><%= def_req.adult %></td>
        <td><%= def_req.date_of_birth %></td>
        <td><%= def_req.appropriate_adult %></td>
        <td><%= def_req.custody_number %></td>
        <td><%= def_req.allegations %></td>
        <td><%= def_req.comments %></td>
        <td><%= def_req.time_of_arrival %></td>
      </tr>
    <% end %>
    </tbody>
  </table>
</div>
<script>
  $(document).ready(function () {

    // connect to server like normal
    var dispatcher = new WebSocketRails('localhost:3000/websocket');

    // subscribe to the channel
    var channel = dispatcher.subscribe('defence_request_changes');

    // bind to a channel event
    channel.bind('defence_request_change', function(data) {
      var current_count = $(".defence_requests tbody tr").length
      var defence_request_html = "<td>" +
                                  current_count +
                                  "</td><td>" +
                                  data.solicitor_type +
                                  "</td><td>" +
                                  data.solicitor_name +
                                  "</td><td>" +
                                  data.solicitor_firm +
                                  "</td><td>" +
                                  data.scheme +
                                  "</td><td>" +
                                  data.phone_number +
                                  "</td><td>" +
                                  data.detainee_surname +
                                  "</td><td>" +
                                  data.detainee_first_name +
                                  "</td><td>" +
                                  data.gender +
                                  "</td><td>" +
                                  data.adult +
                                  "</td><td>" +
                                  data.date_of_birth +
                                  "</td><td>" +
                                  data.appropriate_adult +
                                  "</td><td>" +
                                  data.custody_number +
                                  "</td><td>" +
                                  data.allegations +
                                  "</td><td>" +
                                  data.comments +
                                  "</td><td>" +
                                  data.time_of_arrival +
                                  "</td>"
      $("#dr_" + data.id).html(defence_request_html)
      $("#dr_" + data.id).effect("highlight", 1500);
    });
  });
</script>